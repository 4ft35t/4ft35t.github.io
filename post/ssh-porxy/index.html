<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>SSH 跳板机与代理 | 4ft35t blog</title>
<meta property="og:title" content="SSH 跳板机与代理 - 4ft35t blog">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-06-03T16:55:35+08:00">
<meta property="article:modified_time" content="2020-06-03T16:55:35+08:00">
<meta name=Keywords content="openwrt,lede,router">
<meta name=description content="SSH 跳板机与代理">
<meta name=author content="af.test">
<meta property="og:url" content="https://4ft35t.github.io/post/ssh-porxy/">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href=https://4ft35t.github.io/>
4ft35t blog
</a>
<p class=description>折腾笔记</p>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href=https://4ft35t.github.io/>首页</a>
<a href=https://4ft35t.github.io/archives/ title=归档>归档</a>
<a href=https://4ft35t.github.io/about/ title=关于>关于</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>SSH 跳板机与代理</h1>
</header>
<date class="post-meta meta-date">
2020年6月3日
</date>
<div class=post-meta>
<span>|</span>
<span class=meta-category><a href=/categories/network>Network</a></span>
</div>
<div class=post-content>
<p>基于各种复杂环境，ssh 无法直接连接目标主机，需要借助中间的跳板机或者代理来连接。通常使用 ssh-agent 来通过跳板机连接目标主机，使用 ProxyCommand 或者 ProxyJump 连接更方便。</p>
<h3 id=跳板机>跳板机</h3>
<p>在　<code>~/.ssh/config</code> 中给跳板机一个方便记忆的别名，比如　jumpserver</p>
<pre><code class=language-config data-lang=config>Host jumpserver
    User root
    HostName 1.2.3.4
    Port 2222
    IdentityFile ~/.ssh/jump.pem
</code></pre><p>之后就可以通过　<code>ssh jumpserver</code> 登录到跳板机。</p>
<p>通过跳板机连接目标主机：</p>
<p><code>ssh -o ProxyCommand="ssh -W %h:%p jumpserver" usr@10.0.0.1</code></p>
<p>或者写入 config 文件，使用 <code>ssh dst</code> 直接登录目标主机</p>
<pre><code class=language-config data-lang=config>Host dst
    User usr
    HostName 10.0.0.1
    Port 22
    ProxyCommand ssh -W %h:%p jumpserver
</code></pre><p>较新版本的 ssh 客户端可以使用 ProxyJump</p>
<p><code>ssh -J jumpserver usr@10.0.0.1</code></p>
<p>或者写入 config 文件</p>
<pre><code class=language-config data-lang=config>Host dst
    User usr
    HostName 10.0.0.1
    Port 22
    ProxyJump jumpserver
</code></pre><p>不同版本 ssh 客户端的差异如下</p>
<p><strong>ProxyCommand 与 ProxyJump</strong>
所有命令向后兼容，新版本可以使用老版本命令</p>
<ul>
<li>
<p>远古 SSH 客户端，OpenSSH &lt; 5.4</p>
<p><code>ProxyCommand ssh jumpserver exec nc %h %p</code></p>
<p>或者
<code>ssh -tt usr1@Jumphost ssh -tt usr2@FooServer</code></p>
</li>
<li>
<p>中古 SSH 客户端，5.4 &lt;= OpenSSH &lt;= 7.2</p>
<p><code>ProxyCommand ssh jumpserver -W %h:%p</code></p>
</li>
<li>
<p>现代 SSH 客户端，OpenSSH >= 7.3</p>
<p><code>ProxyJump jumpserver</code></p>
<p>命令行使用
<code>ssh -J jumpserver user@dst-host</code></p>
</li>
</ul>
<h3 id=代理>代理</h3>
<h4 id=socks-代理>socks 代理</h4>
<ul>
<li>
<p>nc <code>ProxyCommand nc -x 127.0.0.1:1080 %h %p</code></p>
</li>
<li>
<p><a href=https://github.com/larryhou/connect-proxy>https://github.com/larryhou/connect-proxy</a> <code>ProxyCommand connect-proxy -S 127.0.0.1:1080 %h %p</code></p>
</li>
</ul>
<h4 id=httphttps-代理>HTTP/HTTPS 代理</h4>
<ul>
<li>
<p>nc <code>ProxyCommand nc -X connect -x proxyhost:proxyport %h %p</code></p>
</li>
<li>
<p><a href=https://github.com/bryanpkc/corkscrew>https://github.com/bryanpkc/corkscrew</a> <code>ProxyCommand /usr/local/bin/corkscrew proxyhost proxyport %h %p</code></p>
</li>
</ul>
<p><strong>corkscrew 在代理不稳定时比 nc 可靠</strong></p>
<h3 id=参考链接>参考链接</h3>
<ul>
<li><a href=https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts>https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts</a></li>
<li><a href=https://www.cyberciti.biz/faq/linux-unix-ssh-proxycommand-passing-through-one-host-gateway-server/>https://www.cyberciti.biz/faq/linux-unix-ssh-proxycommand-passing-through-one-host-gateway-server/</a></li>
</ul>
</div>
<div class=post-archive>
<h2>See Also</h2>
<ul class=listing>
<li><a href=/post/fix-windows-store-0x80131500-error/>解决应用商店 0x80131500 错误</a></li>
<li><a href=/post/jegotrip-takes-long-time-to-connect/>解决无忧行长时间显示“正在连接电话服务器”问题</a></li>
<li><a href=/post/hugo-auto-deploy-with-github-actions/>使用 Github Actions 自动部署 Hugo</a></li>
<li><a href=/about/>关于我</a></li>
<li><a href=/archives/>归档</a></li>
</ul>
</div>
<div class="post-meta meta-tags">
<ul class=clearfix>
<li><a href=/tags/ssh>ssh</a></li>
<li><a href=/tags/proxy>proxy</a></li>
</ul>
</div>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=4ft35t/4ft35t.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
<footer id=footer>
<div>
&copy; 2021 <a href=https://4ft35t.github.io/>4ft35t blog By af.test</a>
</div>
<br>
<div>
<div class=github-badge>
<a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
</div>
<div class=github-badge>
<a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
</div>
<div class=github-badge>
<a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
</div>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-163577388-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://4ft35t.github.io/>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=https://4ft35t.github.io/post/android-screenshoot-remote/ title="Android 远程截图">Android 远程截图</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/pd-qc-dc/ title="PD/QC 电源转 DC 头输出">PD/QC 电源转 DC 头输出</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/bash-exit-in-conditional/ title="bash 条件退出踩坑">bash 条件退出踩坑</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/promark3-flash-iceman-firmware/ title="Promark3 使用 冰人（iceman）固件">Promark3 使用 冰人（iceman）固件</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/ssh-porxy/ title="SSH 跳板机与代理">SSH 跳板机与代理</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/fix-windows-store-0x80131500-error/ title="解决应用商店 0x80131500 错误">解决应用商店 0x80131500 错误</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/jegotrip-takes-long-time-to-connect/ title=解决无忧行长时间显示“正在连接电话服务器”问题>解决无忧行长时间显示“正在连接电话服务器”问题</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/hugo-auto-deploy-with-github-actions/ title="使用 Github Actions 自动部署 Hugo">使用 Github Actions 自动部署 Hugo</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
<li><a href=https://4ft35t.github.io/categories/android/>Android (1)</a></li>
<li><a href=https://4ft35t.github.io/categories/github/>Github (1)</a></li>
<li><a href=https://4ft35t.github.io/categories/linux/>Linux (1)</a></li>
<li><a href=https://4ft35t.github.io/categories/mess/>Mess (2)</a></li>
<li><a href=https://4ft35t.github.io/categories/network/>Network (3)</a></li>
<li><a href=https://4ft35t.github.io/categories/windows/>Windows (1)</a></li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/tags/>标签</a></h3>
<div class=tagcloud>
<a href=https://4ft35t.github.io/tags/0x80072efd/>0x80072EFD</a>
<a href=https://4ft35t.github.io/tags/0x80131500/>0x80131500</a>
<a href=https://4ft35t.github.io/tags/adb/>adb</a>
<a href=https://4ft35t.github.io/tags/android/>android</a>
<a href=https://4ft35t.github.io/tags/autojs/>autojs</a>
<a href=https://4ft35t.github.io/tags/bash/>bash</a>
<a href=https://4ft35t.github.io/tags/cgi/>cgi</a>
<a href=https://4ft35t.github.io/tags/charger/>charger</a>
<a href=https://4ft35t.github.io/tags/dc/>DC</a>
<a href=https://4ft35t.github.io/tags/error/>error</a>
<a href=https://4ft35t.github.io/tags/exit/>exit</a>
<a href=https://4ft35t.github.io/tags/github/>github</a>
<a href=https://4ft35t.github.io/tags/hugo/>hugo</a>
<a href=https://4ft35t.github.io/tags/ip/>IP</a>
<a href=https://4ft35t.github.io/tags/jegotrip/>jegotrip</a>
<a href=https://4ft35t.github.io/tags/pd/>PD</a>
<a href=https://4ft35t.github.io/tags/pi-hole/>pi-hole</a>
<a href=https://4ft35t.github.io/tags/pihole/>pihole</a>
<a href=https://4ft35t.github.io/tags/proxmark3/>proxmark3</a>
<a href=https://4ft35t.github.io/tags/proxy/>proxy</a>
<a href=https://4ft35t.github.io/tags/qc/>QC</a>
<a href=https://4ft35t.github.io/tags/rfid/>rfid</a>
<a href=https://4ft35t.github.io/tags/scrcpy/>scrcpy</a>
<a href=https://4ft35t.github.io/tags/screenshoot/>screenshoot</a>
<a href=https://4ft35t.github.io/tags/shell/>shell</a>
<a href=https://4ft35t.github.io/tags/ssh/>ssh</a>
<a href=https://4ft35t.github.io/tags/test/>test</a>
<a href=https://4ft35t.github.io/tags/windows/>windows</a>
</div>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=https://4ft35t.github.io/index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</body>
</html>