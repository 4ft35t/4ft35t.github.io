<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>bash 条件退出踩坑 | 4ft35t blog</title>
<meta property="og:title" content="bash 条件退出踩坑 - 4ft35t blog">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-06-19T17:55:19+08:00">
<meta property="article:modified_time" content="2020-06-19T17:55:19+08:00">
<meta name=Keywords content="openwrt,lede,router">
<meta name=description content="bash 条件退出踩坑">
<meta name=author content="af.test">
<meta property="og:url" content="https://4ft35t.github.io/post/bash-exit-in-conditional/">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href=https://4ft35t.github.io/>
4ft35t blog
</a>
<p class=description>折腾笔记</p>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href=https://4ft35t.github.io/>首页</a>
<a href=https://4ft35t.github.io/archives/ title=归档>归档</a>
<a href=https://4ft35t.github.io/about/ title=关于>关于</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>bash 条件退出踩坑</h1>
</header>
<date class="post-meta meta-date">
2020年6月19日
</date>
<div class=post-meta>
<span>|</span>
<span class=meta-category><a href=/categories/linux>Linux</a></span>
</div>
<div class=post-content>
<p>一个小脚本，<code>[ $status != "success" ] && exit ２</code>,在 status 值是 success 时，最终的返回状态码是１，而不是０，有点诡异。</p>
<h3 id=排查>排查</h3>
<p>这个写法以前在脚本里经常写，稳定运行未出错。对比之前的脚本后发现差异，之前的脚本 exit 是提前退出，后面还有内容；这个脚本exit是上层调用脚本反馈最终结果，exit 是最后一行。</p>
<p>修改脚本后一切正常</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>status<span style=color:#f92672>=</span>success
<span style=color:#f92672>[</span> $status !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;success&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>２</span>
echo
</code></pre></div><h3 id=原因分析>原因分析</h3>
<p>使用　bash -x 可以看出差异，</p>
<p>exit　在最后一行</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash -x t.sh
+ status<span style=color:#f92672>=</span>success
+ <span style=color:#e6db74>&#39;[&#39;</span> success <span style=color:#e6db74>&#39;!=&#39;</span> success <span style=color:#e6db74>&#39;]&#39;</span>
</code></pre></div><p>exit 不在最后一行</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash -x t.sh
+ status<span style=color:#f92672>=</span>success
+ <span style=color:#e6db74>&#39;[&#39;</span> success <span style=color:#e6db74>&#39;!=&#39;</span> success <span style=color:#e6db74>&#39;]&#39;</span>
+ echo
</code></pre></div><p>shell 会将最后一条命令的返回状态码作为整个脚本的返回状态码。test 在最后一行时，<code>[ $status != "success" ]</code> 的返回结果非0，后面的　&& 内容不会执行，整个脚本结束，脚本返回状态码就是中括号内test命令的反馈状态码。　　　　　　</p>
<h3 id=避坑经验>避坑经验</h3>
<ul>
<li>退出用或逻辑 <code>||</code>，避免用与逻辑 <del>&&</del></li>
<li>一定要用 <strong>&& 做退出条件时，不能作为脚本或者函数的最后一条命令</strong></li>
</ul>
<p>上面脚本改造成||退出</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span> $status <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;success&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>||</span> exit <span style=color:#ae81ff>２</span>
</code></pre></div><p>因为是最后一行，还可以直接省略后面的内容</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span> $status <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;success&#34;</span> <span style=color:#f92672>]</span>
</code></pre></div>
</div>
<div class=post-archive>
<h2>See Also</h2>
<ul class=listing>
<li><a href=/post/promark3-flash-iceman-firmware/>Promark3 使用 冰人（iceman）固件</a></li>
<li><a href=/post/ssh-porxy/>SSH 跳板机与代理</a></li>
<li><a href=/post/fix-windows-store-0x80131500-error/>解决应用商店 0x80131500 错误</a></li>
<li><a href=/post/jegotrip-takes-long-time-to-connect/>解决无忧行长时间显示“正在连接电话服务器”问题</a></li>
<li><a href=/post/hugo-auto-deploy-with-github-actions/>使用 Github Actions 自动部署 Hugo</a></li>
</ul>
</div>
<div class="post-meta meta-tags">
<ul class=clearfix>
<li><a href=/tags/bash>bash</a></li>
<li><a href=/tags/exit>exit</a></li>
<li><a href=/tags/test>test</a></li>
<li><a href=/tags/shell>shell</a></li>
</ul>
</div>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=4ft35t/4ft35t.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
<footer id=footer>
<div>
&copy; 2021 <a href=https://4ft35t.github.io/>4ft35t blog By af.test</a>
</div>
<br>
<div>
<div class=github-badge>
<a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
</div>
<div class=github-badge>
<a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
</div>
<div class=github-badge>
<a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
</div>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-163577388-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://4ft35t.github.io/>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=https://4ft35t.github.io/post/android-screenshoot-remote/ title="Android 远程截图">Android 远程截图</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/pd-qc-dc/ title="PD/QC 电源转 DC 头输出">PD/QC 电源转 DC 头输出</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/bash-exit-in-conditional/ title="bash 条件退出踩坑">bash 条件退出踩坑</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/promark3-flash-iceman-firmware/ title="Promark3 使用 冰人（iceman）固件">Promark3 使用 冰人（iceman）固件</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/ssh-porxy/ title="SSH 跳板机与代理">SSH 跳板机与代理</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/fix-windows-store-0x80131500-error/ title="解决应用商店 0x80131500 错误">解决应用商店 0x80131500 错误</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/jegotrip-takes-long-time-to-connect/ title=解决无忧行长时间显示“正在连接电话服务器”问题>解决无忧行长时间显示“正在连接电话服务器”问题</a>
</li>
<li>
<a href=https://4ft35t.github.io/post/hugo-auto-deploy-with-github-actions/ title="使用 Github Actions 自动部署 Hugo">使用 Github Actions 自动部署 Hugo</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
<li><a href=https://4ft35t.github.io/categories/android/>Android (1)</a></li>
<li><a href=https://4ft35t.github.io/categories/github/>Github (1)</a></li>
<li><a href=https://4ft35t.github.io/categories/linux/>Linux (1)</a></li>
<li><a href=https://4ft35t.github.io/categories/mess/>Mess (2)</a></li>
<li><a href=https://4ft35t.github.io/categories/network/>Network (3)</a></li>
<li><a href=https://4ft35t.github.io/categories/windows/>Windows (1)</a></li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title><a href=/tags/>标签</a></h3>
<div class=tagcloud>
<a href=https://4ft35t.github.io/tags/0x80072efd/>0x80072EFD</a>
<a href=https://4ft35t.github.io/tags/0x80131500/>0x80131500</a>
<a href=https://4ft35t.github.io/tags/adb/>adb</a>
<a href=https://4ft35t.github.io/tags/android/>android</a>
<a href=https://4ft35t.github.io/tags/autojs/>autojs</a>
<a href=https://4ft35t.github.io/tags/bash/>bash</a>
<a href=https://4ft35t.github.io/tags/cgi/>cgi</a>
<a href=https://4ft35t.github.io/tags/charger/>charger</a>
<a href=https://4ft35t.github.io/tags/dc/>DC</a>
<a href=https://4ft35t.github.io/tags/error/>error</a>
<a href=https://4ft35t.github.io/tags/exit/>exit</a>
<a href=https://4ft35t.github.io/tags/github/>github</a>
<a href=https://4ft35t.github.io/tags/hugo/>hugo</a>
<a href=https://4ft35t.github.io/tags/ip/>IP</a>
<a href=https://4ft35t.github.io/tags/jegotrip/>jegotrip</a>
<a href=https://4ft35t.github.io/tags/pd/>PD</a>
<a href=https://4ft35t.github.io/tags/pi-hole/>pi-hole</a>
<a href=https://4ft35t.github.io/tags/pihole/>pihole</a>
<a href=https://4ft35t.github.io/tags/proxmark3/>proxmark3</a>
<a href=https://4ft35t.github.io/tags/proxy/>proxy</a>
<a href=https://4ft35t.github.io/tags/qc/>QC</a>
<a href=https://4ft35t.github.io/tags/rfid/>rfid</a>
<a href=https://4ft35t.github.io/tags/scrcpy/>scrcpy</a>
<a href=https://4ft35t.github.io/tags/screenshoot/>screenshoot</a>
<a href=https://4ft35t.github.io/tags/shell/>shell</a>
<a href=https://4ft35t.github.io/tags/ssh/>ssh</a>
<a href=https://4ft35t.github.io/tags/test/>test</a>
<a href=https://4ft35t.github.io/tags/windows/>windows</a>
</div>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=https://4ft35t.github.io/index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</body>
</html>