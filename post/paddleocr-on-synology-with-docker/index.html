<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='在群晖 NAS 上折腾百度 PaddleOCR 的踩坑过程'><title>群晖 NAS 上运行 PaddleOCR</title>
<link rel=canonical href=https://4ft35t.github.io/post/paddleocr-on-synology-with-docker/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property='og:title' content='群晖 NAS 上运行 PaddleOCR'><meta property='og:description' content='在群晖 NAS 上折腾百度 PaddleOCR 的踩坑过程'><meta property='og:url' content='https://4ft35t.github.io/post/paddleocr-on-synology-with-docker/'><meta property='og:site_name' content='4ft35t blog'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='docker'><meta property='article:tag' content='linux'><meta property='article:tag' content='ocr'><meta property='article:tag' content='error'><meta property='article:tag' content='python'><meta property='article:tag' content='paddleocr'><meta property='article:published_time' content='2022-04-21T19:22:21+08:00'><meta property='article:modified_time' content='2022-04-21T19:22:21+08:00'><meta property='og:image' content='https://raw.githubusercontent.com/PaddlePaddle/PaddleOCR/release/2.6/doc/PaddleOCR_log.png'><meta name=twitter:title content="群晖 NAS 上运行 PaddleOCR"><meta name=twitter:description content="在群晖 NAS 上折腾百度 PaddleOCR 的踩坑过程"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://raw.githubusercontent.com/PaddlePaddle/PaddleOCR/release/2.6/doc/PaddleOCR_log.png'><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-163577388-1","auto"),ga("send","pageview"))</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><div class=site-meta><h1 class=site-name><a href=/>4ft35t blog</a></h1><h2 class=site-description>随手折腾，顺手记录</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/index.xml target=_blank><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg>
<span>RSS</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://4ft35t.github.io/ selected>中文</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/post/paddleocr-on-synology-with-docker/><img src=https://raw.githubusercontent.com/PaddlePaddle/PaddleOCR/release/2.6/doc/PaddleOCR_log.png loading=lazy alt="Featured image of post 群晖 NAS 上运行 PaddleOCR"></a></div><div class=article-details><header class=article-category><a href=/categories/linux/>Linux</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/paddleocr-on-synology-with-docker/>群晖 NAS 上运行 PaddleOCR</a></h2><h3 class=article-subtitle>在群晖 NAS 上折腾百度 PaddleOCR 的踩坑过程</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2022-04-21</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 3 分钟</time></div></footer></div></header><section class=article-content><p>本文的起因是 Manjaro 的 python 版本升级到 3.10 后，PaddleOCR 无法运行。尝试用 pyenv 安装 3.9.10 版 python 后，执行命令 <code>paddleocr</code> 报错</p><blockquote><p>ImportError: /opt/github/ocr/venv3910/lib/python3.9/site-packages/paddle/fluid/core_avx.so: undefined symbol: _dl_sym, version GLIBC_PRIVATE</p></blockquote><p>这个报错，在 PaddleOCR 官方的 github 仓库 issue 有人发过, ubuntu 20.10 上遇到此报错，https://github.com/PaddlePaddle/Paddle/issues/36801 。</p><p>只能把 PaddleOCR 放在 Docker 运行了。不过官方镜像的体积高达 11G，我只需要 OCR 功能，不做样本训练，应该有很大的精简空间。</p><p>此前在 VPS 上的 ubuntu 20.04 里用过 PaddleOCR，故选择 ubuntu 20.04 做基础镜像。群晖 NAS 上有多个 Docker 服务，PaddleOCR 同样丢群晖跑。</p><h2 id=运行-ubuntu-2004>运行 ubuntu 20.04</h2><p>ssh 登录群晖后，执行 <code>sudo su</code>，输入当前用户的密码，切换到 <strong>root</strong>。</p><p>执行下面命令，进入 ubuntu 的 bash 终端</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker pull ubuntu:20.04
</span></span><span class=line><span class=cl>docker run -it ubuntu:20.04 bash
</span></span></code></pre></td></tr></table></div></div><h2 id=系统的软件源换成阿里云>系统的软件源换成阿里云</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cp /etc/apt/sources.list{,.bak}
</span></span><span class=line><span class=cl>sed -i &#39;s/archive.ubuntu.com/mirrors.aliyun.com/&#39; /etc/apt/sources.list
</span></span><span class=line><span class=cl>apt-get update
</span></span></code></pre></td></tr></table></div></div><h2 id=安装-python-环境>安装 python 环境</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>apt-get install python3 python3-pip wget
</span></span><span class=line><span class=cl>mkdir /root/.pip
</span></span><span class=line><span class=cl>echo &#39;[global]&#39; &gt; /root/.pip/pip.conf
</span></span><span class=line><span class=cl>echo &#39;index-url = https://pypi.doubanio.com/simple&#39; &gt;&gt; /root/.pip/pip.conf
</span></span></code></pre></td></tr></table></div></div><h2 id=安装-paddleocr>安装 PaddleOCR</h2><p>按官方文档操作，https://github.com/PaddlePaddle/PaddleOCR/blob/release/2.4/doc/doc_ch/quickstart.md</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pip install paddlepaddle -i https://mirror.baidu.com/pypi/simple
</span></span><span class=line><span class=cl>pip install paddleocr
</span></span></code></pre></td></tr></table></div></div><p>一切进展顺利，下面开始踩坑</p><h2 id=填坑过程>填坑过程</h2><p>执行 <code>paddleocr -h</code>, 看是否有报错信息。错误一个接一个的来，下面安出现顺序解决</p><h3 id=modulenotfounderror-no-module-named-paddlefluidcore_noavx>ModuleNotFoundError: No module named &lsquo;paddle.fluid.core_noavx&rsquo;</h3><p>群晖的 CPU 太古老了，不支持 AVX(Advanced Vector Extensions) 指令集, 需要 noavx 的预编译包。
在这个 issue <a class=link href=https://github.com/PaddlePaddle/PaddleOCR/issues/4275 target=_blank rel=noopener>https://github.com/PaddlePaddle/PaddleOCR/issues/4275</a> 中找到线索，官方的预先编译 whl 列表 <a class=link href=https://www.paddlepaddle.org.cn/documentation/docs/zh/develop/install/Tables.html#whl-release target=_blank rel=noopener>https://www.paddlepaddle.org.cn/documentation/docs/zh/develop/install/Tables.html#whl-release</a></p><p><code>cpu-mkl-noavx</code> 版本的预编译 whl 只有 python 3.8 的，正好和 ubuntu 20.04 的 python 版本一致。</p><p>下载地址</p><blockquote><p><a class=link href=https://paddle-wheel.bj.bcebos.com/2.2.1/linux/linux-cpu-mkl-noavx/paddlepaddle-2.2.1-cp38-cp38-linux_x86_64.whl target=_blank rel=noopener>https://paddle-wheel.bj.bcebos.com/2.2.1/linux/linux-cpu-mkl-noavx/paddlepaddle-2.2.1-cp38-cp38-linux_x86_64.whl</a></p></blockquote><p>当前版本已是 2.2.2, 把连接中 2.2.1 全部替换成 2.2.2</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>echo https://paddle-wheel.bj.bcebos.com/2.2.1/linux/linux-cpu-mkl-noavx/paddlepaddle-2.2.1-cp38-cp38-linux_x86_64.whl | sed &#39;s/2.2.1/2.2.2/g&#39;
</span></span></code></pre></td></tr></table></div></div><p>下载安装, 此问题解决</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>wget https://paddle-wheel.bj.bcebos.com/2.2.2/linux/linux-cpu-mkl-noavx/paddlepaddle-2.2.2-cp38-cp38-linux_x86_64.whl
</span></span><span class=line><span class=cl>pip install --force-reinstal paddlepaddle-2.2.2-cp38-cp38-linux_x86_64.whl
</span></span></code></pre></td></tr></table></div></div><h3 id=importerror-libglso1-cannot-open-shared-object-file-no-such-file-or-directory>ImportError: libGL.so.1: cannot open shared object file: No such file or directory</h3><p><code>pip install opencv-python-headless==4.2.0.32</code></p><h3 id=importerror-libgthread-20so0-cannot-open-shared-object-file-no-such-file-or-directory>ImportError: libgthread-2.0.so.0: cannot open shared object file: No such file or directory</h3><p><code>apt-get install libglib2.0-0 libsm6 libxrender1 libxext6</code></p><p>中途会出现选择时区的交互，依次选择 <code>6. Asia</code> - <code>19. Chongqing</code></p><h3 id=importerror-libgompso1-cannot-open-shared-object-file-no-such-file-or-directory>ImportError: libgomp.so.1: cannot open shared object file: No such file or directory</h3><p><code>apt-get install libgomp1</code></p><p>至此，paddleocr 可以正常运行。</p><h2 id=添加-api>添加 API</h2><p>使用 flask 提供简单的 ocr 识别 API，可以上传图片或者从 url 下载图片，输出格式可选 text 或者 json，默认 text。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/ocr&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;PUT&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ocr_text</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>files</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;img&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>img</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>img_url</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;imgurl&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>img</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>img_url</span><span class=p>)</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>        <span class=n>img</span> <span class=o>=</span> <span class=n>BytesIO</span><span class=p>(</span><span class=n>img</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>file_obj</span> <span class=o>=</span> <span class=n>BytesIO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>img</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>file_obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>img</span> <span class=o>=</span> <span class=n>file_obj</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>img</span><span class=p>)</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=s1>&#39;RGB&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>ocr</span><span class=o>.</span><span class=n>ocr</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>img</span><span class=p>),</span> <span class=n>det</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>rec</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=bp>cls</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>i</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>result</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>output_format</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;outtype&#39;</span><span class=p>,</span> <span class=s1>&#39;text&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>output_format</span> <span class=o>==</span> <span class=s1>&#39;text&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>text</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;success&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s1>&#39;results&#39;</span><span class=p>:</span> <span class=p>[]}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>each</span> <span class=ow>in</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;confidence&#39;</span><span class=p>:</span> <span class=n>each</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>item</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;text&#39;</span><span class=p>:</span> <span class=n>each</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;text_region&#39;</span><span class=p>:</span> <span class=n>each</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span><span class=p>[</span><span class=s1>&#39;results&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=api-使用>API 使用</h3><ul><li><p>上传文件识别, 输出 text 格式</p><p><code>curl 127.0.0.1:5000/ocr -F img=@/tmp/img.png</code></p></li><li><p>从图片url识别, 并输出 json 格式
<code>curl 127.0.0.1:5000/ocr -F imgurl=https://raw.githubusercontent.com/PaddlePaddle/PaddleOCR/release/2.4/doc/imgs_en/254.jpg -F outtype=json</code></p></li></ul><h2 id=创建-dockerfile>创建 Dockerfile</h2><p>上面提到的安装过程中需要交互选择时区，会中断 docker 编译，通过设置 <code>ENV DEBIAN_FRONTEND=noninteractive</code> 来规避</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>FROM</span> <span class=n>ubuntu</span><span class=p>:</span><span class=mf>20.04</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>EXPOSE</span> <span class=mi>5000</span>
</span></span><span class=line><span class=cl><span class=n>ENV</span> <span class=n>TZ</span><span class=o>=</span><span class=n>Asia</span><span class=o>/</span><span class=n>Shanghai</span>
</span></span><span class=line><span class=cl><span class=n>ENV</span> <span class=n>DEBIAN_FRONTEND</span><span class=o>=</span><span class=n>noninteractive</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ARG</span> <span class=n>PADDLE_VER</span><span class=o>=</span><span class=mf>2.2</span><span class=o>.</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>COPY</span> <span class=n>app</span><span class=o>.</span><span class=n>py</span> <span class=o>/</span>
</span></span><span class=line><span class=cl><span class=n>COPY</span> <span class=n>requirements</span><span class=o>.</span><span class=n>txt</span> <span class=o>/</span><span class=n>tmp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>RUN</span> <span class=n>apt</span><span class=o>-</span><span class=n>get</span> <span class=n>update</span> \
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=n>apt</span><span class=o>-</span><span class=n>get</span> <span class=n>install</span> <span class=o>-</span><span class=n>y</span> <span class=n>python3</span> <span class=n>python3</span><span class=o>-</span><span class=n>pip</span> <span class=n>libgomp1</span> <span class=n>libglib2</span><span class=o>.</span><span class=mi>0</span><span class=o>-</span><span class=mi>0</span> <span class=n>libsm6</span> <span class=n>libxrender1</span> <span class=n>libxext6</span> \
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=n>pip</span> <span class=n>install</span> <span class=o>-</span><span class=n>r</span> <span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>requirements</span><span class=o>.</span><span class=n>txt</span> \
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=n>wget</span> <span class=o>--</span><span class=n>directory</span><span class=o>-</span><span class=n>prefix</span> <span class=o>/</span><span class=n>tmp</span><span class=o>/</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>paddle</span><span class=o>-</span><span class=n>wheel</span><span class=o>.</span><span class=n>bj</span><span class=o>.</span><span class=n>bcebos</span><span class=o>.</span><span class=n>com</span><span class=o>/$</span><span class=p>{</span><span class=n>PADDLE_VER</span><span class=p>}</span><span class=o>/</span><span class=n>linux</span><span class=o>/</span><span class=n>linux</span><span class=o>-</span><span class=n>cpu</span><span class=o>-</span><span class=n>mkl</span><span class=o>-</span><span class=n>noavx</span><span class=o>/</span><span class=n>paddlepaddle</span><span class=o>-$</span><span class=p>{</span><span class=n>PADDLE_VER</span><span class=p>}</span><span class=o>-</span><span class=n>cp38</span><span class=o>-</span><span class=n>cp38</span><span class=o>-</span><span class=n>linux_x86_64</span><span class=o>.</span><span class=n>whl</span> \
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=n>pip</span> <span class=n>install</span> <span class=o>--</span><span class=n>force</span><span class=o>-</span><span class=n>reinstall</span> <span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>paddlepaddle</span><span class=o>-$</span><span class=p>{</span><span class=n>PADDLE_VER</span><span class=p>}</span><span class=o>-</span><span class=n>cp38</span><span class=o>-</span><span class=n>cp38</span><span class=o>-</span><span class=n>linux_x86_64</span><span class=o>.</span><span class=n>whl</span>
</span></span><span class=line><span class=cl><span class=n>RUN</span> <span class=n>apt</span><span class=o>-</span><span class=n>get</span> <span class=o>-</span><span class=n>y</span> <span class=n>remove</span> <span class=n>python3</span><span class=o>-</span><span class=n>pip</span> \
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=n>apt</span><span class=o>-</span><span class=n>get</span> <span class=o>-</span><span class=n>y</span> <span class=n>autoremove</span> \
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=n>apt</span><span class=o>-</span><span class=n>get</span> <span class=o>-</span><span class=n>y</span> <span class=n>install</span> <span class=o>--</span><span class=n>no</span><span class=o>-</span><span class=n>install</span><span class=o>-</span><span class=n>recommends</span> <span class=n>python3</span><span class=o>-</span><span class=n>setuptools</span> \
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=n>rm</span> <span class=o>-</span><span class=n>rf</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=p>{</span><span class=n>apt</span><span class=p>,</span><span class=n>dpkg</span><span class=p>,</span><span class=n>cache</span><span class=p>,</span><span class=nb>log</span><span class=p>}</span><span class=o>/</span> <span class=o>/</span><span class=n>root</span><span class=o>/.</span><span class=n>cache</span> <span class=o>/</span><span class=n>tmp</span><span class=o>/*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CMD</span> <span class=p>[</span><span class=s2>&#34;python3&#34;</span><span class=p>,</span> <span class=s2>&#34;/app.py&#34;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Dockerfile 及其它文件在 Github Repo <a class=link href=https://github.com/4ft35t/Paddleocr-docker target=_blank rel=noopener>https://github.com/4ft35t/Paddleocr-docker</a></p><p>Docker Hub 地址 <a class=link href=https://hub.docker.com/r/c403/paddleocr target=_blank rel=noopener>https://hub.docker.com/r/c403/paddleocr</a></p><p>最后吐槽一下，PaddleOCR 的文档太混乱了, 很多内容在 issues 里，不在文档。</p><h2 id=参考链接>参考链接</h2><ul><li><a class=link href=https://github.com/PaddlePaddle/PaddleOCR/issues/4275 target=_blank rel=noopener>https://github.com/PaddlePaddle/PaddleOCR/issues/4275</a></li><li><a class=link href=https://www.paddlepaddle.org.cn/documentation/docs/zh/develop/install/Tables.html#whl-release target=_blank rel=noopener>https://www.paddlepaddle.org.cn/documentation/docs/zh/develop/install/Tables.html#whl-release</a></li><li><a class=link href=https://blog.csdn.net/Max_ZhangJF/article/details/108920050 target=_blank rel=noopener>https://blog.csdn.net/Max_ZhangJF/article/details/108920050</a></li><li><a class=link href=https://github.com/PaddlePaddle/PaddleOCR/issues/1735 target=_blank rel=noopener>https://github.com/PaddlePaddle/PaddleOCR/issues/1735</a></li><li><a class=link href=https://stackoverflow.com/questions/62786028/importerror-libgthread-2-0-so-0-cannot-open-shared-object-file-no-such-file-o target=_blank rel=noopener>https://stackoverflow.com/questions/62786028/importerror-libgthread-2-0-so-0-cannot-open-shared-object-file-no-such-file-o</a></li><li><a class=link href=https://github.com/explosion/spaCy/issues/1110 target=_blank rel=noopener>https://github.com/explosion/spaCy/issues/1110</a></li><li><a class=link href=https://askubuntu.com/questions/909277/avoiding-user-interaction-with-tzdata-when-installing-cert-in-a-docker-contai target=_blank rel=noopener>https://askubuntu.com/questions/909277/avoiding-user-interaction-with-tzdata-when-installing-cert-in-a-docker-contai</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/docker/>Docker</a>
<a href=/tags/linux/>Linux</a>
<a href=/tags/ocr/>Ocr</a>
<a href=/tags/error/>Error</a>
<a href=/tags/python/>Python</a>
<a href=/tags/paddleocr/>Paddleocr</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>相关文章</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/post/backup-nas-photo-to-goole-photo-via-pixel-for-unlimited/><div class=article-image><img src=https://oss-cn-hangzhou.aliyuncs.com/codingsky/cdn/img/2019-07-25/dc29fbcc14b8c4acce61ba33a7f2af63.jpg loading=lazy data-key data-hash=https://oss-cn-hangzhou.aliyuncs.com/codingsky/cdn/img/2019-07-25/dc29fbcc14b8c4acce61ba33a7f2af63.jpg></div><div class=article-details><h2 class=article-title>利用 Pixel 一代的无限存储备份 NAS 照片</h2></div></a></article><article class=has-image><a href=/post/bash-exit-in-conditional/><div class=article-image><img src=https://pic1.zhimg.com/v2-6101b6f0fb5664fd5f959332faefb38f_1440w.jpg loading=lazy data-key data-hash=https://pic1.zhimg.com/v2-6101b6f0fb5664fd5f959332faefb38f_1440w.jpg></div><div class=article-details><h2 class=article-title>bash 条件退出踩坑</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=4ft35t/4ft35t.github.io issue-term=pathname crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 4ft35t blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#运行-ubuntu-2004>运行 ubuntu 20.04</a></li><li><a href=#系统的软件源换成阿里云>系统的软件源换成阿里云</a></li><li><a href=#安装-python-环境>安装 python 环境</a></li><li><a href=#安装-paddleocr>安装 PaddleOCR</a></li><li><a href=#填坑过程>填坑过程</a><ol><li><a href=#modulenotfounderror-no-module-named-paddlefluidcore_noavx>ModuleNotFoundError: No module named &lsquo;paddle.fluid.core_noavx&rsquo;</a></li><li><a href=#importerror-libglso1-cannot-open-shared-object-file-no-such-file-or-directory>ImportError: libGL.so.1: cannot open shared object file: No such file or directory</a></li><li><a href=#importerror-libgthread-20so0-cannot-open-shared-object-file-no-such-file-or-directory>ImportError: libgthread-2.0.so.0: cannot open shared object file: No such file or directory</a></li><li><a href=#importerror-libgompso1-cannot-open-shared-object-file-no-such-file-or-directory>ImportError: libgomp.so.1: cannot open shared object file: No such file or directory</a></li></ol></li><li><a href=#添加-api>添加 API</a><ol><li><a href=#api-使用>API 使用</a></li></ol></li><li><a href=#创建-dockerfile>创建 Dockerfile</a></li><li><a href=#参考链接>参考链接</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>